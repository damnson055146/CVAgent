# 智能格式处理逻辑说明

## 概述

我们的系统实现了智能的格式处理逻辑，遵循Word中的格式优先级规则，确保格式的一致性和合理性。

## 格式优先级规则

### 1. 优先级顺序（从高到低）
1. **标题格式** (H1, H2, H3) - 最高优先级
2. **粗体格式** (**文本**)
3. **斜体格式** (*文本*)
4. **代码格式** (`文本`)

### 2. 格式冲突处理

#### 标题中的格式处理
- **标题本身已经是粗体**，所以在标题中应用粗体是多余的
- **标题不支持斜体**，所以在标题中应用斜体会被忽略
- **标题不支持代码格式**，所以在标题中应用代码格式会被忽略

#### 具体示例

**输入**: `# Yuxiang Chen哈哈`
- **用户选中 "Yuxiang Chen哈哈" 并点击粗体**
- **处理结果**: 保持为 `# Yuxiang Chen哈哈`（移除粗体标记）
- **原因**: 标题本身就是粗体，不需要额外的粗体标记

**输入**: `# Yuxia**ng Chen哈哈**`
- **处理结果**: `# Yuxiang Chen哈哈`（移除粗体标记）
- **原因**: 标题格式优先级高于行内粗体格式

**输入**: `# Yuxiang *Chen哈哈*`
- **处理结果**: `# Yuxiang Chen哈哈`（移除斜体标记）
- **原因**: 标题不支持斜体格式

**输入**: `# Yuxiang `Chen哈哈``
- **处理结果**: `# Yuxiang Chen哈哈`（移除代码标记）
- **原因**: 标题不支持代码格式

### 3. 普通文本中的格式处理

**输入**: `**粗体文本** *斜体文本*`
- **处理结果**: 正常显示粗体和斜体
- **原因**: 普通文本支持所有行内格式

**输入**: `**粗体中的*斜体*文本**`
- **处理结果**: 粗体文本，其中"斜体"部分也是粗体
- **原因**: 粗体优先级高于斜体，但两者可以共存

## 实现逻辑

### 1. 智能格式处理函数

```javascript
const processFormatWithPriority = (text, isHeading = false, headingLevel = 0) => {
  if (isHeading) {
    // 移除粗体标记，因为标题本身就是粗体
    let processedText = text.replace(/\*\*(.*?)\*\*/g, '$1');
    // 移除斜体标记，因为标题不支持斜体
    processedText = processedText.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '$1');
    // 移除代码标记
    processedText = processedText.replace(/`([^`]+?)`/g, '$1');
    return processedText;
  }
  // 对于普通文本，正常处理所有格式
  return text;
};
```

### 2. 应用场景

1. **Word文档生成**: 在 `parseMarkdownToWordElements` 中应用
2. **PDF文档生成**: 在 `parseMarkdownToPdfElements` 中应用
3. **预览渲染**: 在预览组件中应用

## 用户体验

### 1. 直观的格式行为
- 用户在标题中应用粗体时，系统会智能地忽略这个操作
- 避免了格式冲突和视觉混乱
- 保持了文档的专业性和一致性

### 2. 符合用户期望
- 遵循Word等主流编辑器的行为
- 用户不会感到困惑或意外
- 提供了可预测的格式处理结果

## 测试用例

### 测试1: 标题中的粗体
- **输入**: `# **Yuxiang Chen哈哈**`
- **期望输出**: `# Yuxiang Chen哈哈`（标题格式，粗体显示）

### 测试2: 标题中的斜体
- **输入**: `# *Yuxiang Chen哈哈*`
- **期望输出**: `# Yuxiang Chen哈哈`（标题格式，无斜体）

### 测试3: 标题中的代码
- **输入**: `# `Yuxiang Chen哈哈``
- **期望输出**: `# Yuxiang Chen哈哈`（标题格式，无代码格式）

### 测试4: 普通文本中的格式
- **输入**: `**粗体** *斜体* \`代码\``
- **期望输出**: 正常显示所有格式

## 总结

这个智能格式处理逻辑确保了：
1. **格式一致性**: 标题始终保持统一的格式
2. **用户友好**: 避免了格式冲突和混乱
3. **专业性**: 生成的文档具有专业的外观
4. **可维护性**: 清晰的逻辑便于维护和扩展 