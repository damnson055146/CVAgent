# PDF和Word生成器渲染规则更新

## 概述

本次更新完全重写了PDF和Word生成器，使其与预览区的渲染规则完全一致，实现真正的"所见即所得"。

## 主要更新内容

### 1. PDF生成器 (`pdfGenerators.js`)

#### 样式配置完全匹配预览区
- **标题样式**：
  - H1: 22pt, 黑色, 粗体, 间距 8/4mm
  - H2: 15pt, 黑色, 粗体, 下划线, 间距 5/2mm
  - H3: 14pt, 蓝色(#2563eb), 粗体, 间距 5/4mm

- **文本样式**：
  - 基础字体: 12pt, 黑色, 行高 1.4
  - 段落间距: 4mm
  - 强调文本: 颜色 #22223b, 粗体

- **列表样式**：
  - 字体: 12pt, 缩进 5mm, 项目符号 •
  - 间距: 3mm

- **分割线**：
  - 颜色: #b6c6e3, 虚线样式
  - 间距: 10/10mm

#### 字体处理
- 中文字符检测
- 支持 SimSun, Microsoft YaHei, helvetica
- 自动字体回退机制

#### 内联格式支持
- **粗体**: `**文本**` - 支持颜色和字体样式
- **斜体**: `*文本*` - 支持斜体样式
- **代码**: `` `代码` `` - 支持等宽字体和高亮

#### 块级格式支持
- **左右分栏**: `::: left` / `::: right` 成对块
- **单独对齐**: `::: sololeft` / `::: solocenter` / `::: soloright`
- **居中对齐**: `::: center`
- **标题**: `# H1`, `## H2`, `### H3`
- **列表**: `- 项目` / `* 项目` / `+ 项目`
- **分割线**: `---` 或 `***`

### 2. Word生成器 (`wordGenerators.js`)

#### 样式配置完全匹配预览区
- **标题样式**：
  - H1: 44半点, 黑色, 粗体, 间距 480/240
  - H2: 32半点, 黑色, 粗体, 下边框, 间距 20/200
  - H3: 24半点, 蓝色(#2563eb), 粗体, 间距 300/240

- **文本样式**：
  - 基础字体: 24半点, 行高 1.5
  - 段落间距: 280
  - 强调文本: 颜色 #22223b, 粗体

- **列表样式**：
  - 字体: 24半点, 缩进 600, 项目符号 •
  - 间距: 200

- **分割线**：
  - 颜色: #b6c6e3, 虚线样式
  - 间距: 600/600

#### 字体处理
- 默认使用 SimSun 字体
- 支持配置字体大小和行高
- 动态样式配置生成

#### 内联格式支持
- **粗体**: `**文本**` - 支持颜色和字体样式
- **斜体**: `*文本*` - 支持斜体样式
- **代码**: `` `代码` `` - 支持等宽字体和高亮

#### 块级格式支持
- **左右分栏**: 使用 tabStops 实现两栏布局
- **单独对齐**: 支持左、中、右对齐
- **居中对齐**: 支持居中对齐
- **标题**: 支持 H1/H2/H3 标题样式
- **列表**: 支持项目符号列表
- **分割线**: 使用重复字符实现

## 技术实现细节

### 1. 动态样式配置
```javascript
const generatePdfStyleConfig = (config) => {
  // 根据用户配置动态调整字体大小和间距
  const baseFontSize = config.fontSize || 12;
  const spacingRatio = (baseFontSize / 12) * 0.7;
  // ...
};
```

### 2. 内联格式解析
```javascript
const parseInlineFormatting = (text, styleConfig) => {
  // 使用正则表达式解析粗体、斜体、代码格式
  const formatHandlers = [
    { regex: /\*\*(.*?)\*\*/g, name: 'bold', handler: ... },
    { regex: /(?<!\*)\*[^*]+\*(?!\*)/g, name: 'italic', handler: ... },
    { regex: /`([^`]+?)`/g, name: 'code', handler: ... }
  ];
  // ...
};
```

### 3. 块级格式处理
```javascript
// 支持嵌套块和复杂布局
if (block.hasNested) {
  // 递归处理嵌套内容
  const nestedChildren = generateWordContent(block.content, config);
  children.push(...nestedChildren);
} else {
  // 处理普通内容
  // ...
}
```

## 兼容性保证

### 1. 函数别名
为了保持向后兼容，保留了所有原有函数名：
```javascript
export const generateBasicPdf = generateAdvancedPdf;
export const generateSimpleChinesePdfV2 = generateAdvancedPdf;
export const generatePdfWithMsyhFont = generateAdvancedPdf;
export const generateSimplePdfV2 = generateAdvancedPdf;
```

### 2. 配置参数
支持所有原有配置参数：
- `font`: 字体名称
- `fontSize`: 字体大小
- `lineHeight`: 行高
- `resumeData`: 简历数据

## 测试用例

### 1. 基础格式测试
```markdown
# 一级标题
## 二级标题
### 三级标题

**粗体文本** 和 *斜体文本* 以及 `代码文本`

- 列表项目1
- 列表项目2
- 列表项目3

---
```

### 2. 对齐格式测试
```markdown
::: left
**左侧内容**
:::
::: right
**右侧内容**
:::

::: solocenter
# 居中的标题
:::

::: sololeft
- 左对齐列表
- 第二个项目
:::
```

### 3. 复杂布局测试
```markdown
::: left
**公司名称**
职位名称
:::
::: right
**地点**
时间范围
:::

## 工作经历

**项目名称** - *技术栈*
- 负责功能A的开发
- 负责功能B的优化
```

## 性能优化

### 1. 字体加载优化
- 按需加载字体
- 字体回退机制
- 错误处理

### 2. 内存管理
- 及时清理临时DOM元素
- 避免内存泄漏
- 优化大文档处理

### 3. 渲染优化
- 批量处理文本格式
- 减少重复计算
- 缓存样式配置

## 错误处理

### 1. 字体错误
- 自动回退到系统字体
- 记录警告日志
- 继续生成文档

### 2. 格式错误
- 跳过无效格式
- 保留原始文本
- 显示错误信息

### 3. 文件保存错误
- 提供详细错误信息
- 建议解决方案
- 记录错误日志

## 总结

本次更新实现了：

1. **完全一致的渲染规则** - PDF和Word输出与预览区完全一致
2. **全面的格式支持** - 支持所有Markdown格式和对齐方式
3. **优秀的用户体验** - 真正的"所见即所得"
4. **稳定的性能** - 优化的字体处理和内存管理
5. **良好的兼容性** - 保持向后兼容

用户现在可以：
- 在编辑器中看到准确的预览
- 生成与预览完全一致的PDF和Word文档
- 享受流畅的编辑和导出体验 